# 苹果内购配置指南

## 简介
本指南将帮助您在App Store Connect中配置静心岛app的内购商品。

## 前提条件
1. 拥有Apple Developer账号
2. 已在App Store Connect中创建应用
3. 已配置税务和银行信息

## 商品配置

### 充值商品（消费型商品）
在App Store Connect的"功能"选项卡中，创建以下消费型内购商品：

| 商品ID | 显示名称 | 价格 | 描述 | 测试商品
|--------|----------|------|------|
| lelele_12 | 12元金币礼包 | ¥12.00 | 840个金币 |
| lelele_38 | 38元金币礼包 | ¥38.00 | 2660个金币 |
| lelele_68 | 68元金币礼包 | ¥68.00 | 4760个金币 |
| lelele_98 | 98元金币礼包 | ¥98.00 | 6860个金币 |
| lelele_198 | 198元金币礼包 | ¥198.00 | 13860个金币 |
| lelele_298 | 298元金币礼包 | ¥298.00 | 20860个金币 |
| lelele_598 | 598元金币礼包 | ¥598.00 | 41860个金币 |

| 商品ID | 显示名称 | 价格 | 描述 | 正式商品
|--------|----------|------|------|
| pack_coin_ios_12 | 12元金币礼包 | ¥12.00 | 840个金币 |
| pack_coin_ios_38 | 38元金币礼包 | ¥38.00 | 2660个金币 |
| pack_coin_ios_68 | 68元金币礼包 | ¥68.00 | 4760个金币 |
| pack_coin_ios_98 | 98元金币礼包 | ¥98.00 | 6860个金币 |
| pack_coin_ios_198 | 198元金币礼包 | ¥198.00 | 13860个金币 |
| pack_coin_ios_298 | 298元金币礼包 | ¥298.00 | 20860个金币 |
| pack_coin_ios_598 | 598元金币礼包 | ¥598.00 | 41860个金币 |

### VIP订阅商品（非消费型商品）
创建以下非消费型内购商品：

| 商品ID | 显示名称 | 价格 | 描述 |  测试商品
|--------|----------|------|------|
| lelelevip68 | 1个月会员服务 | ¥68.00 | 享受专属VIP特权，包括无限AI对话等 |
| lelelevip168 | 3个月会员服务 | ¥168.00 | 享受专属VIP特权，包括无限AI对话等 |
| lelelevip399 | 12个月会员服务 | ¥399.00 | 享受专属VIP特权，包括无限AI对话等 |

| 商品ID | 显示名称 | 价格 | 描述 |  正式商品VIP
|--------|----------|------|------|
| pack_vip_68 | 1个月会员服务 | ¥68.00 | 享受专属VIP特权，包括无限AI对话等 |
| pack_vip_168 | 3个月会员服务 | ¥168.00 | 享受专属VIP特权，包括无限AI对话等 |
| pack_vip_399 | 12个月会员服务 | ¥399.00 | 享受专属VIP特权，包括无限AI对话等 |

## 配置步骤

### 1. 创建内购商品
1. 登录 [App Store Connect](https://appstoreconnect.apple.com)
2. 选择您的应用
3. 点击"功能"选项卡
4. 在"App内购买项目"部分，点击"+"按钮
5. 选择商品类型：
   - 充值商品选择"消费型"
   - VIP商品选择"非消费型"
6. 填写商品信息：
   - 参考ID：使用上表中的商品ID
   - 显示名称：使用上表中的显示名称
   - 描述：使用上表中的描述

### 2. 设置价格
1. 在商品详情页面，点击"价格"
2. 选择对应的价格等级
3. 确认所有国家/地区的价格

### 3. 提供元数据
1. 添加商品的本地化信息
2. 如需要，添加商品截图
3. 添加审核信息

### 4. 提交审核
1. 确保所有商品信息完整
2. 将商品状态设置为"准备提交"
3. 与应用版本一起提交审核

## 测试配置

### 沙盒测试
1. 在App Store Connect中创建沙盒测试用户
2. 在iOS设备上使用沙盒测试用户登录
3. 测试所有内购功能

### 测试流程
1. 启动应用
2. 尝试购买充值商品
3. 验证金币是否正确增加
4. 尝试购买VIP商品
5. 验证VIP状态是否正确开通

## 代码集成说明

### 已实现的功能
- ✅ 内购服务初始化
- ✅ 商品查询和展示
- ✅ 购买流程处理
- ✅ 购买验证（简化版）
- ✅ 商品发放（金币充值和VIP开通）
- ✅ 错误处理和用户反馈

### 主要文件
- `lib/services/in_app_purchase_service.dart` - 内购服务核心逻辑
- `lib/screens/profile/recharge_center_screen.dart` - 充值中心页面
- `lib/screens/profile/vip_subscription_screen.dart` - VIP订阅页面
- `lib/models/user.dart` - 用户模型（包含金币和VIP信息）

### 生产环境注意事项
1. **收据验证**: 当前使用简化的本地验证，生产环境建议使用服务器端验证
2. **错误处理**: 完善各种边缘情况的处理
3. **日志记录**: 添加详细的购买日志用于问题排查
4. **恢复购买**: VIP商品支持恢复购买功能

## 常见问题

### Q: 商品无法加载
A: 检查商品ID是否正确，确保商品已在App Store Connect中创建且状态为"准备提交"

### Q: 购买失败
A: 检查网络连接，确保使用正确的Apple ID，验证商品配置

### Q: 测试时使用真实支付
A: 确保在设置中登录沙盒测试账号，而不是真实Apple ID

### Q: VIP状态不同步
A: 检查购买回调处理，确保正确更新用户VIP状态和到期时间

## 联系支持
如果在配置过程中遇到问题，请参考Apple的官方文档或联系技术支持。 